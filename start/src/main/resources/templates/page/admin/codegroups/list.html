<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/admin_layout}">
<head>
  <meta charset="UTF-8">
  <title>코드그룹관리</title>
</head>
<body layout:fragment="content">
  <main class="main-wrapper">
    <div class="main-content">
      <!-- Breadcrumb -->
      <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
        <div class="breadcrumb-title pe-3">
          <i class="fadeIn animated bx bx-home"></i>
          코드그룹관리
        </div>
        <div class="ps-3">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 p-0">
              <li class="breadcrumb-item active" aria-current="page">리스트</li>
            </ol>
          </nav>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <!-- 필터 Row 1: 검색 -->
              <div class="row mb-3 align-items-center">
                <div class="col-auto">
                  <div class="input-group" style="width: 400px;">
                    <input type="text" class="form-control" placeholder="코드그룹명, 설명으로 검색..." id="searchInput" th:value="${queryParams.search}">
                    <button class="btn btn-outline-secondary" type="button" id="searchBtn"><i class="bx bx-search-alt"></i></button>
                  </div>
                </div>
                <div class="col text-end">
                  <button class="btn btn-outline-secondary" type="button" onclick="setPeriod(7)">1주일</button>
                  <button class="btn btn-outline-secondary ms-2" type="button" onclick="setPeriod(30)">1개월</button>
                  <div class="d-inline-block ms-2 position-relative top-3">
                    <input type="date" class="form-control d-inline-block" style="width: 150px;" id="start" 
                          th:value="${queryParams != null and queryParams.params != null ? queryParams.params['start'] : ''}">
                    <span class="mx-2">~</span>
                    <input type="date" class="form-control d-inline-block" style="width: 150px;" id="end" 
                          th:value="${queryParams != null and queryParams.params != null ? queryParams.params['end'] : ''}">
                  </div>
                  <button class="btn btn-outline-secondary ms-2" type="button" id="dateSearchBtn">검색<i class="bx bx-search"></i></button>
                </div>
              </div>

              <!-- 필터 Row 2: 등록하기 -->
              <div class="row mb-3 align-items-center">
                <div class="col-auto">
                </div>
                <div class="col text-end">
                  <a href="/admin/codegroups/create" class="btn btn-primary"><i class="bx bx-plus-circle me-1"></i>등록하기</a>
                </div>
              </div>
              
              <!-- 테이블 -->
              <div class="table-responsive" style="min-height: 600px;">
                <table class="table table-hover" id="codegroups-table">
                  <thead>
                    <tr class="text-center">
                      <th style="width: 50px;"><input type="checkbox" class="form-check-input" id="checkAll"></th>
                      <th>No</th>
                      <th>ID</th>
                      <th>코드그룹명</th>
                      <th>설명</th>
                      <th>등록일</th>
                      <th style="width: 100px;">관리</th>
                    </tr>
                  </thead>
                  <tbody class="text-center">
                    <tr th:if="${pageInfo == null or #lists.isEmpty(pageInfo.list)}">
                      <td colspan="7" class="text-center py-5 text-muted">
                        조회된 데이터가 없습니다.
                      </td>
                    </tr>
                    <tr th:each="item : ${pageInfo.list}">
                      <td>
                        <input type="checkbox" class="form-check-input codegroups-checkbox" th:value="${item.id}">
                      </td>
                      <td th:text="${item.no}">1</td>
                      <td th:text="${item.id}">1</td>
                      <td th:text="${item.name}">코드그룹명</td>
                      <td th:text="${item.description}">설명</td>
                      <td th:text="${#dates.format(item.createdAt,'yyyy-MM-dd HH:mm:ss')}">2024-12-19</td>
                      <td>
                        <a th:href="@{/admin/codegroups/update/{id}(id=${item.id})}"
                          class="btn btn-sm btn-outline-primary"><i class="bx bx-edit"></i></a>
                        <button class="btn btn-sm btn-outline-danger"
                                th:onclick="deleteCodeGroup( [[${item.id}]] )">
                          <i class="bx bx-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="card-footer pt-3">
                <th:block th:replace="~{UI/fragments/common/page::page}"></th:block>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="/assets/plugins/datatable/js/jquery.dataTables.min.js"></script>
  <script src="/assets/plugins/datatable/js/dataTables.bootstrap5.min.js"></script>
  
  <script>
    // 개별 삭제
    function deleteCodeGroup(id) {
      if (!id) {
        $alert('오류', '삭제할 ID를 찾을 수 없습니다.', 'error');
        return;
      }
      $confirm('코드그룹 삭제', '삭제하시겠습니까?', 'warning', '삭제', '취소')
        .then(function(result) {
          if (!result.isConfirmed) return;
          $ajax({
            url: '/api/admin/codegroups/' + id,
            type: 'DELETE',
            success: function(res) {
              if (res) {
                $alert('삭제 완료', '코드그룹이 성공적으로 삭제되었습니다.', 'success')
                  .then(() => location.reload());
              } else {
                $alert('삭제 실패', '삭제에 실패했습니다.', 'error');
              }
            },
            error: function(xhr) {
              console.error('Delete failed:', xhr.status, xhr.responseText);
              $alert('삭제 실패', '삭제에 실패했습니다.', 'error');
            }
          });
        });
    }
  </script>

  <script>
    $(document).ready(function() {
      // 전체 체크
      $('#checkAll').on('change', function () {
        $('.codegroups-checkbox').prop('checked', this.checked);
      });

      // 개별 체크 변경 시
      $(document).on('change', '.codegroups-checkbox', function () {
        const total = $('.codegroups-checkbox').length;
        const checked = $('.codegroups-checkbox:checked').length;
        $('#checkAll').prop('checked', total > 0 && total === checked);
      });

      // 검색창 엔터키
      $('#searchInput').on('keypress', function(e) {
        if (e.which === 13) applyFilters();
      });

      $('#searchBtn, #dateSearchBtn').click(function() {
        applyFilters();
      });
    });

    function applyFilters() {
      const search = $('#searchInput').val();
      const start = $('#start').val();
      const end = $('#end').val();

      let params = new URLSearchParams();
      params.append('page', '1');

      if (search) params.append('search', search);
      if (start) params.append('params[start]', start);
      if (end) params.append('params[end]', end);

      location.href = '/admin/codegroups?' + params.toString();
    }
    
    function setPeriod(days) {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - days);

      const toYmd = (d) => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      $('#start').val(toYmd(start));
      $('#end').val(toYmd(end));
      applyFilters();
    }
  </script>

  <script>
    $(document).ready(function () {
      const table = $('#codegroups-table').DataTable({
        lengthChange: false,
        paging: false,
        searching: false,
        info: false,
        buttons: ['copy', 'excel', 'pdf', 'print']
      });

      table.buttons().container()
        .appendTo('#codegroups-table_wrapper .col-md-6:eq(0)');
    });
  </script>
</body>
</html>
