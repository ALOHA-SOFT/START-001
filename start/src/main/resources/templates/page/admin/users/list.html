<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/admin_layout}">
<head>
  <meta charset="UTF-8">
  <title>회원관리</title>
</head>
<body layout:fragment="content">
  <main class="main-wrapper">
    <div class="main-content">
      <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
        <div class="breadcrumb-title pe-3">
          <i class="fadeIn animated bx bx-home"></i>
          회원관리
        </div>
        <div class="ps-3">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 p-0">
              <li class="breadcrumb-item active" aria-current="page">리스트</li>
            </ol>
          </nav>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">

              <!-- 필터 Row 1: 검색 -->
              <div class="row mb-3 align-items-center">
                <div class="col-auto">
                  <div class="input-group" style="width: 400px;">
                    <input type="text" class="form-control" placeholder="이름, 아이디, 연락처로 검색..." id="searchInput" th:value="${queryParams.search}">
                    <button class="btn btn-outline-secondary" type="button" id="searchBtn"><i class="bx bx-search-alt"></i></button>
                  </div>
                </div>
                <div class="col text-end">
                  <button class="btn btn-outline-secondary" type="button" onclick="setPeriod(7)">1주일</button>
                  <button class="btn btn-outline-secondary ms-2" type="button" onclick="setPeriod(30)">1개월</button>
                  <div class="d-inline-block ms-2 position-relative top-3">
                    <input type="date" class="form-control d-inline-block" style="width: 150px;" id="start" 
                          th:value="${queryParams != null and queryParams.params != null ? queryParams.params['start'] : ''}">
                    <span class="mx-2">~</span>
                    <input type="date" class="form-control d-inline-block" style="width: 150px;" id="end" 
                          th:value="${queryParams != null and queryParams.params != null ? queryParams.params['end'] : ''}">
                  </div>
                  <button class="btn btn-outline-secondary ms-2" type="button" id="dateSearchBtn">검색<i class="bx bx-search"></i></button>
                </div>
              </div>

              <!-- 필터 Row 2: 성별, 활성화, 등록하기 -->
              <div class="row mb-3 align-items-center">
                <div class="col-auto">
                  <select class="form-select d-inline-block" style="width: auto;" id="enabledFilter">
                    <option value="">활성 전체</option>
                    <option value="1" th:selected="${queryParams != null and queryParams.params != null and queryParams.params['enabled'] == '1'}">활성</option>
                    <option value="0" th:selected="${queryParams != null and queryParams.params != null and queryParams.params['enabled'] == '0'}">비활성</option>
                  </select>
                </div>
                <div class="col text-end">
                  <a href="/admin/users/create" class="btn btn-primary"><i class="bx bx-plus-circle me-1"></i>등록하기</a>
                </div>
              </div>
              
              <!-- 테이블 -->
              <div class="table-responsive" style="min-height: 600px;">
                <table class="table table-hover" id="users-table">
                  <thead>
                    <tr class="text-center">
                      <th style="width: 50px;"><input type="checkbox" class="form-check-input" id="checkAll"></th>
                      <th>No</th>
                      <th>아이디</th>
                      <th>이름</th>
                      <th>연락처</th>
                      <th>이메일</th>
                      <th>활성</th>
                      <th>등록일</th>
                      <th style="width: 100px;">관리</th>
                    </tr>
                  </thead>
                  <tbody class="text-center">
                    <!-- 데이터 없을 때 -->
                    <tr th:if="${pageInfo == null or #lists.isEmpty(pageInfo.list)}">
                      <td colspan="8" class="text-center py-5 text-muted">
                        조회된 회원이 없습니다.
                      </td>
                    </tr>

                    <!-- 데이터 있을 때 -->
                    <tr th:each="users : ${pageInfo.list}">
                      <td>
                        <input type="checkbox" class="form-check-input user-checkbox" th:value="${users.no}">
                        <input type="hidden" id="userId" th:value="${users.id}">
                      </td>
                      <td th:text="${users.no}">userNo</td>
                      <td th:text="${users.username}">user001</td>
                      <td th:text="${users.name}">홍길동</td>
                      <td th:text="${users.tel}">010-1234-5678</td>
                      <td th:text="${users.email}">user@example.com</td>
                      <td>
                        <span class="badge"
                              th:classappend="${users.enabled} ? ' bg-success' : ' bg-secondary'"
                              th:text="${users.enabled} ? '활성' : '비활성'">
                          활성
                        </span>
                      </td>

                      <td th:text="${#dates.format(users.createdAt,'yyyy-MM-dd HH:mm:ss')}">2024-12-19</td>

                      <td>
                        <a th:href="@{/admin/users/update/{id}(id=${users.id})}"
                          class="btn btn-sm btn-outline-primary"><i class="bx bx-edit"></i></a>

                        <button class="btn btn-sm btn-outline-danger"
                                th:attr="data-id=${users.id}"
                                onclick="deleteUser(this)">
                          <i class="bx bx-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="card-footer pt-3">
                <th:block th:replace="~{UI/fragments/common/page::page}"></th:block>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="/assets/plugins/datatable/js/jquery.dataTables.min.js"></script>
  <script src="/assets/plugins/datatable/js/dataTables.bootstrap5.min.js"></script>
  

  <script>
    // ✅ 회원 삭제 (목록에서도 동작)
    function deleteUser(el) {
      const id = el?.getAttribute('data-id'); // 또는 $(el).data('id')

      if (!id) {
        $alert('오류', '삭제할 사용자 ID를 찾을 수 없습니다.', 'error');
        return;
      }

      $confirm('회원 삭제', '삭제하시겠습니까?', 'warning', '삭제', '취소')
        .then(function (result) {
          if (!result.isConfirmed) return;

          $ajax({
            url: '/admin/users/delete/' + id,
            type: 'DELETE',
            success: function (res) {
              // 서버가 문자열을 주는 경우도 대비
              if (res && typeof res === 'object' && res.success === false) {
                $alert('회원 삭제', '회원 삭제에 실패했습니다.', 'error');
                return;
              }

              $alert('회원 삭제', '회원 정보가 성공적으로 삭제되었습니다.', 'success')
                .then(() => location.href = '/admin/users');
            },
            error: function (xhr) {
              $('#submitBtn').prop('disabled', false);

              console.error('User delete failed:', xhr.status, xhr.responseText);
              $alert('회원 삭제', '회원 정보 삭제에 실패했습니다.', 'error');
            }
          });
        });
    }
  </script>

  <script>
    $(document).ready(function() {

    // 전체 체크
    $('#checkAll').on('change', function () {
      $('.user-checkbox').prop('checked', this.checked);
    });

    // 개별 체크 변경 시 전체체크 상태 반영
    $(document).on('change', '.user-checkbox', function () {
      const total = $('.user-checkbox').length;
      const checked = $('.user-checkbox:checked').length;
      $('#checkAll').prop('checked', total > 0 && total === checked);
    });

    // 1. 드롭박스 변경 시 즉시 검색 실행
    $('#enabledFilter').on('change', function () {
      applyFilters();
    });

    // 2. 검색창 엔터키 지원
    $('#searchInput').on('keypress', function(e) {
        if (e.which === 13) applyFilters();
    });

    // 3. 버튼 클릭 이벤트
    $('#dateSearchBtn, #searchBtn').click(function() {
        applyFilters();
    });
  });

    // ✅ 목록 필터 적용(서버로 GET 이동)
    function applyFilters(extra = {}) {
      const search = $('#searchInput').val();
      const start = $('#start').val();
      const end = $('#end').val();

      const enabled = $('#enabledFilter').val();  // '' | '1' | '0'

      let params = new URLSearchParams();
      params.append('page', '1');

      if (search) params.append('search', search);
      if (start) params.append('params[start]', start);
      if (end) params.append('params[end]', end);
      if (enabled !== '') params.append('params[enabled]', enabled);

      Object.entries(extra).forEach(([k, v]) => {
        if (v !== null && v !== undefined && String(v).trim() !== '') {
          params.set(k, String(v).trim());
        }
      });

      location.href = '/admin/users?' + params.toString();
    }
    
    // ✅ 기간 버튼: 7일/30일
    function setPeriod(days) {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - days);

      const toYmd = (d) => {
        const offset = d.getTimezoneOffset() * 60000;
        return new Date(d - offset).toISOString().substring(0, 10);
      };

      $('#start').val(toYmd(start));
      $('#end').val(toYmd(end));

      // 7일=filter 1, 30일=filter 2 (원하는 규칙 그대로)
      const filter = (days === 7) ? 1 : (days === 30) ? 2 : null;
      applyFilters(filter ? { filter } : {});
    }

  </script>

  <!-- ⬇️⭐⭐⭐ dataTable ⭐⭐⭐⬇️ -->
  <script src="/assets/plugins/datatable/js/jquery.dataTables.min.js"></script>
	<script src="/assets/plugins/datatable/js/dataTables.bootstrap5.min.js"></script>

  <script>
    $(document).ready(function () {
      const table = $('#users-table').DataTable({
        lengthChange: false,
        paging: false,
        searching: false,
        info: false,
        buttons: ['copy', 'excel', 'pdf', 'print']
      });

      table.buttons().container()
        .appendTo('#users-table_wrapper .col-md-6:eq(0)');
    });
  </script>
  <!-- ⬆️⭐⭐⭐ dataTable ⭐⭐⭐⬆️ -->
</body>
</html>
