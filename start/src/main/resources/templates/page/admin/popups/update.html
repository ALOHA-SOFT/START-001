<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/admin_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>팝업 수정</title>
</head>
<body layout:fragment="content">
  <main class="main-wrapper">
    <div class="main-content">
      <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
        <div class="breadcrumb-title pe-3">
          <i class="fadeIn animated bx bx-home"></i>
          팝업관리
        </div>
        <div class="ps-3">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 p-0">
              <li class="breadcrumb-item active" aria-current="page">수정하기</li>
            </ol>
          </nav>
        </div>
      </div>

      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="card">
            <div class="card-body p-4">
              <h5 class="mb-4">팝업 정보 수정</h5>
              <form id="popupUpdateForm" class="needs-validation" novalidate th:object="${popup}">
                <!-- CSRF TOKEN -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <!-- 원본 번호 (수정 시 참조용) -->
                <input type="hidden" th:field="*{no}" id="originalNo">
                
                <div class="row g-3">
                  
                  <!-- 팝업 ID (읽기 전용) -->
                  <div class="col-md-6">
                    <label for="id" class="form-label">팝업 ID</label>
                    <input type="text" class="form-control" th:field="*{id}" readonly>
                  </div>

                  <!-- 팝업 타입 -->
                  <div class="col-md-6">
                    <label for="type" class="form-label">팝업 타입 <span class="text-danger">*</span></label>
                    <select class="form-select" th:field="*{type}" required>
                      <option value="">타입을 선택하세요</option>
                      <option value="MAIN">메인</option>
                    </select>
                    <div class="invalid-feedback">팝업 타입을 선택해주세요.</div>
                  </div>

                  <!-- 팝업명 -->
                  <div class="col-md-6">
                    <label for="name" class="form-label">팝업명 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" th:field="*{name}" required 
                           maxlength="100" placeholder="팝업명을 입력하세요">
                    <div class="invalid-feedback">팝업명을 입력해주세요.</div>
                  </div>

                  <!-- 현재 이미지 -->
                  <div class="col-12" id="currentImageSection" th:if="${popup.url != null and !#strings.isEmpty(popup.url)}">
                    <label class="form-label">현재 이미지</label>
                    <div class="border rounded p-3 bg-light">
                      <div class="d-flex align-items-center gap-3">
                        <img th:src="${popup.url}" alt="현재 팝업 이미지" id="currentImage"
                             style="max-width: 200px; max-height: 200px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 4px;">
                        <div class="flex-grow-1">
                          <p class="mb-2"><strong>이미지 URL:</strong></p>
                          <p class="small text-break mb-2" id="currentImageUrl" th:text="${popup.url}"></p>
                          <button type="button" class="btn btn-sm btn-danger" onclick="deleteCurrentImage()">
                            <i class="bx bx-trash"></i> 현재 이미지 삭제
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- 이미지 등록 방식 선택 -->
                  <div class="col-12" id="imageInputTypeSection">
                    <label class="form-label">이미지 등록/변경</label>
                    <div class="btn-group w-100" role="group">
                      <input type="radio" class="btn-check" name="imageInputType" id="imageTypeNone" value="none" checked>
                      <label class="btn btn-outline-secondary" for="imageTypeNone">변경 안 함</label>
                      
                      <input type="radio" class="btn-check" name="imageInputType" id="imageTypeUrl" value="url">
                      <label class="btn btn-outline-primary" for="imageTypeUrl">URL 입력</label>
                      
                      <input type="radio" class="btn-check" name="imageInputType" id="imageTypeUpload" value="upload">
                      <label class="btn btn-outline-primary" for="imageTypeUpload">파일 업로드</label>
                    </div>
                  </div>

                  <!-- 이미지 URL 입력 -->
                  <div class="col-12 d-none" id="imageUrlSection">
                    <label for="newImageUrl" class="form-label">이미지 URL <span class="text-danger">*</span></label>
                    <input type="url" class="form-control" id="newImageUrl" name="newImageUrl" 
                           maxlength="500" placeholder="https://example.com/image.jpg">
                    <div class="invalid-feedback">이미지 URL을 입력해주세요.</div>
                    <div class="form-text">팝업에 표시할 이미지의 URL을 입력하세요.</div>
                  </div>

                  <!-- 이미지 파일 업로드 -->
                  <div class="col-12 d-none" id="imageUploadSection">
                    <label for="imageFile" class="form-label">이미지 파일 <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="imageFile" accept="image/*">
                    <div class="invalid-feedback">이미지 파일을 선택해주세요.</div>
                    <div class="form-text">JPG, PNG, GIF 형식의 이미지 파일을 업로드하세요.</div>
                    
                    <!-- 이미지 미리보기 -->
                    <div id="imagePreview" class="mt-3 d-none">
                      <img id="previewImage" src="" alt="미리보기" style="max-width: 100%; max-height: 300px; border: 1px solid #dee2e6; border-radius: 4px;">
                      <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeImagePreview()">
                        <i class="bx bx-trash"></i> 이미지 제거
                      </button>
                    </div>
                  </div>

                  <!-- 링크 URL -->
                  <div class="col-md-6">
                    <label for="link" class="form-label">링크 URL</label>
                    <input type="url" class="form-control" th:field="*{link}" 
                           maxlength="500" placeholder="https://example.com">
                    <div class="form-text">팝업 클릭 시 이동할 URL (선택사항)</div>
                  </div>

                  <!-- 노출 순서 -->
                  <div class="col-md-6">
                    <label for="seq" class="form-label">노출 순서</label>
                    <input type="number" class="form-control" th:field="*{seq}" min="1" max="9999">
                    <div class="form-text">숫자가 작을수록 먼저 노출</div>
                  </div>

                  <!-- 표시 기간 -->
                  <div class="col-md-6">
                    <label for="startedAt" class="form-label">시작일시</label>
                    <input type="datetime-local" class="form-control" th:field="*{startedAt}">
                  </div>
                  <div class="col-md-6">
                    <label for="endedAt" class="form-label">종료일시</label>
                    <input type="datetime-local" class="form-control" th:field="*{endedAt}">
                  </div>

                  <!-- 팝업 내용 -->
                  <div class="col-12">
                    <label for="content" class="form-label">팝업 내용</label>
                    <textarea class="form-control" th:field="*{content}" rows="6" 
                              maxlength="1000" placeholder="팝업에 표시할 내용을 입력하세요"></textarea>
                    <div class="form-text">최대 1000자까지 입력 가능합니다.</div>
                  </div>

                  <!-- 표시 여부 -->
                  <div class="col-12">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" th:field="*{isShow}" value="true">
                      <label class="form-check-label" for="isShow">팝업 표시</label>
                    </div>
                  </div>

                  <!-- 버튼 영역 -->
                  <div class="col-12 mt-4">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                      <button type="button" class="btn btn-secondary" onclick="history.back()">취소</button>
                      <button type="submit" class="btn btn-lg btn-primary px-5">수정하기</button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>

    // 현재 이미지 삭제
    async function deleteCurrentImage() {
      const result = await $confirm(
        '이미지 삭제',
        '현재 이미지를 삭제하시겠습니까? 즉시 삭제되며 되돌릴 수 없습니다.',
        'warning',
        '삭제',
        '취소'
      );

      if (!result.isConfirmed) {
        return;
      }

      try {
        const popupId = document.getElementById('id').value;
        const currentImageUrl = document.getElementById('currentImageUrl').textContent.trim();
        
        // 1. Media 테이블에서 이미지 삭제 (S3에서도 함께 삭제됨)
        if (currentImageUrl) {
          try {
            await fetch('/api/common/media/by-url?url=' + encodeURIComponent(currentImageUrl), {
              method: 'DELETE',
              headers: {
                'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
              }
            });
          } catch (error) {
            console.warn('Media 삭제 실패 (계속 진행):', error);
          }
        }
        
        // 2. 팝업의 url 필드를 빈 문자열로 업데이트
        await $ajax({
          url: '/api/admin/popup',
          type: 'PUT',
          data: {
            id: popupId,
            url: ''
          }
        });

        // UI에서 이미지 섹션 제거
        document.getElementById('currentImageSection').remove();
        
        $alert({
          title: '삭제 완료',
          text: '이미지가 삭제되었습니다.',
          icon: 'success',
          confirmButtonText: '확인'
        });

      } catch (error) {
        console.error('이미지 삭제 오류:', error);
        $alert({
          title: '오류',
          text: '이미지 삭제 중 오류가 발생했습니다.',
          icon: 'error',
          confirmButtonText: '확인'
        });
      }
    }

    // 이미지 등록 방식 전환
    document.querySelectorAll('input[name="imageInputType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const imageUrlSection = document.getElementById('imageUrlSection');
        const imageUploadSection = document.getElementById('imageUploadSection');
        const imageUrlInput = document.getElementById('newImageUrl');
        const imageFileInput = document.getElementById('imageFile');
        
        // 모두 숨기기
        imageUrlSection.classList.add('d-none');
        imageUploadSection.classList.add('d-none');
        imageUrlInput.required = false;
        imageFileInput.required = false;
        
        if (this.value === 'url') {
          // URL 입력 방식
          imageUrlSection.classList.remove('d-none');
          imageUrlInput.required = true;
          imageFileInput.value = '';
          removeImagePreview();
        } else if (this.value === 'upload') {
          // 파일 업로드 방식
          imageUploadSection.classList.remove('d-none');
          imageFileInput.required = true;
          imageUrlInput.value = '';
        } else {
          // 변경 안 함
          imageUrlInput.value = '';
          imageFileInput.value = '';
          removeImagePreview();
        }
      });
    });

    // 이미지 파일 선택 시 미리보기
    document.getElementById('imageFile').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        // 파일 타입 체크
        if (!file.type.startsWith('image/')) {
          $alert('파일 타입 오류', '이미지 파일만 업로드 가능합니다.', 'warning');
          event.target.value = '';
          return;
        }
        
        // 미리보기 표시
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('previewImage').src = e.target.result;
          document.getElementById('imagePreview').classList.remove('d-none');
        };
        reader.readAsDataURL(file);
      }
    });

    // 이미지 미리보기 제거
    function removeImagePreview() {
      document.getElementById('imageFile').value = '';
      document.getElementById('previewImage').src = '';
      document.getElementById('imagePreview').classList.add('d-none');
    }

    // 폼 제출
    document.getElementById('popupUpdateForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      event.stopPropagation();

      // 폼 유효성 검사
      if (!this.checkValidity()) {
        this.classList.add('was-validated');
        return;
      }

      const imageInputType = document.querySelector('input[name="imageInputType"]:checked').value;
      let newImageUrl = null;

      try {
        // 1. 이미지 처리
        if (imageInputType === 'upload') {
          // 파일 업로드 방식
          const imageFile = document.getElementById('imageFile').files[0];
          if (!imageFile) {
            $alert('오류', '이미지 파일을 선택해주세요.', 'warning');
            return;
          }

          const popupId = document.getElementById('id').value;

          // 이미지 업로드
          const mediaFormData = new FormData();
          mediaFormData.append('file', imageFile);
          mediaFormData.append('parentId', popupId);
          mediaFormData.append('type', '이미지');
          mediaFormData.append('domain', 'popups');
          mediaFormData.append('isMain', 'true');

          const mediaResponse = await fetch('/api/common/media/upload', {
            method: 'POST',
            headers: {
              'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
            },
            body: mediaFormData
          });

          if (!mediaResponse.ok) {
            throw new Error('이미지 업로드 실패');
          }

          const mediaData = await mediaResponse.json();
          newImageUrl = mediaData.content || mediaData.path;

        } else if (imageInputType === 'url') {
          // URL 입력 방식
          newImageUrl = document.getElementById('newImageUrl').value;
          if (!newImageUrl) {
            $alert('오류', '이미지 URL을 입력해주세요.', 'warning');
            return;
          }
        }

        // 2. 팝업 데이터 수집
        const formData = new FormData(this);
        const popupData = {};
        
        for (let [key, value] of formData.entries()) {
          if (key === 'isShow') {
            popupData[key] = value === 'true';
          } else if (key !== 'imageInputType' && key !== 'newImageUrl') {
            popupData[key] = value;
          }
        }

        // isShow 체크박스가 체크되지 않은 경우 false로 설정
        if (!popupData.isShow) {
          popupData.isShow = false;
        }

        // 3. 이미지 URL 처리
        if (newImageUrl) {
          // 새 이미지가 있으면 교체
          popupData.url = newImageUrl;
        }
        // imageInputType이 'none'이면 url을 변경하지 않음 (기존 값 유지)

        // 4. 수정 요청
        await $ajax({
          url: '/api/admin/popup',
          type: 'PUT',
          data: popupData
        });

        $alert('성공', '팝업이 성공적으로 수정되었습니다.', 'success').then(() => {
          window.location.href = '/admin/popups';
        });

      } catch (error) {
        console.error('팝업 수정 오류:', error);
        $alert('오류', '수정 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
      }
    });

    // Bootstrap validation
    (function() {
      'use strict';
      window.addEventListener('load', function() {
        const forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function(form) {
          form.addEventListener('submit', function(event) {
            if (form.checkValidity() === false) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
          }, false);
        });
      }, false);
    })();
  </script>

</body>
</html>
